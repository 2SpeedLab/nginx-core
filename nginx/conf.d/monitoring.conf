# Monitoring API Server
# Similar to Nginx Plus API

server {
    listen 9145;
    server_name localhost;

    # Security: Allow only specific IPs
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;

    # Disable access logging for metrics endpoint
    access_log off;

    # Prometheus metrics endpoint
    location /metrics {
        content_by_lua_file /etc/nginx/lua/metrics_endpoint.lua;
    }

    # API documentation (must be outside /api/ to avoid nesting conflict)
    location = /api {
        default_type application/json;
        content_by_lua_block {
            ngx.say([[{
  "endpoints": {
    "/metrics": "Prometheus metrics format",
    "/api/stats": "Complete statistics in JSON",
    "/api/health": "Health check status",
    "/api/connections": "Current connection statistics",
    "/api/requests": "Request statistics",
    "/api/upstreams": "Upstream server statistics"
  },
  "version": "1.0.0"
}]])
        }
    }

    # JSON API endpoint (Nginx Plus style)
    location /api/ {
        default_type application/json;

        location = /api/stats {
            content_by_lua_file /etc/nginx/lua/api_stats.lua;
        }

        location = /api/health {
            content_by_lua_file /etc/nginx/lua/api_health.lua;
        }

        location = /api/connections {
            content_by_lua_file /etc/nginx/lua/api_connections.lua;
        }

        location = /api/requests {
            content_by_lua_file /etc/nginx/lua/api_requests.lua;
        }

        location = /api/upstreams {
            content_by_lua_file /etc/nginx/lua/api_upstreams.lua;
        }
    }

    # Simple status page
    location = /status {
        content_by_lua_file /etc/nginx/lua/status_page.lua;
    }
}