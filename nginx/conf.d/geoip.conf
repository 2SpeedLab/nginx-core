location /geoip {
    default_type application/json;
    content_by_lua_block {
        local maxminddb = require "resty.maxminddb"
        local cjson = require "cjson"

        -- Get client IP or IP from query parameter
        local ip = ngx.var.arg_ip or ngx.var.remote_addr

        -- Open City database
        local city_db = maxminddb.new("/usr/local/share/GeoIP/GeoLite2-City.mmdb")
        if not city_db then
            ngx.status = 500
            ngx.say(cjson.encode({error = "Failed to open City database"}))
            return
        end

        -- Lookup IP
        local city_res, err = city_db:lookup(ip)
        if not city_res then
            ngx.status = 404
            ngx.say(cjson.encode({error = "IP not found", ip = ip}))
            return
        end

        -- Return result
        ngx.say(cjson.encode({
            ip = ip,
            city = city_res.city,
            country = city_res.country,
            location = city_res.location,
            postal = city_res.postal,
            subdivisions = city_res.subdivisions
        }))
    }
}

location /geoip/country {
    default_type application/json;
    content_by_lua_block {
        local maxminddb = require "resty.maxminddb"
        local cjson = require "cjson"

        local ip = ngx.var.arg_ip or ngx.var.remote_addr

        -- Open Country database
        local country_db = maxminddb.new("/usr/local/share/GeoIP/GeoLite2-Country.mmdb")
        if not country_db then
            ngx.status = 500
            ngx.say(cjson.encode({error = "Failed to open Country database"}))
            return
        end

        local country_res, err = country_db:lookup(ip)
        if not country_res then
            ngx.status = 404
            ngx.say(cjson.encode({error = "IP not found", ip = ip}))
            return
        end

        ngx.say(cjson.encode({
            ip = ip,
            country = country_res.country,
            continent = country_res.continent
        }))
    }
}